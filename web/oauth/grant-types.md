# Grant Types

The OAuth grant type determines the steps that are involved in the OAuth process. The grant type also affects how the client application communicates with the OAuth service at each stage, including how the access token itself is sent. For this reason, grant types are often referred to as "OAuth flows".

An OAuth service must be configured to support a particular grant type before a client application can initiate the corresponding flow. The client application specifies which grant type it wants to use in the initial authorization request it sends to the OAuth service.

There are several different grant types, each with varying levels of complexity and security considerations. By far the most common Grant types are "authorization code" and "implicit".



{% hint style="warning" %}


_**Authorization Code Grant**: Typically used for server-side applications. It involves the client obtaining an authorization code from the authorization server and exchanging it for an access token._

_**Implicit Grant**: Designed for client-side applications like JavaScript apps running in a web browser. It returns the access token directly to the client without an authorization code exchange._
{% endhint %}

## Authorization Code Grant Type

<figure><img src="../../.gitbook/assets/Diagram3.png" alt=""><figcaption><p>Authorization code grant workflow</p></figcaption></figure>

### **Step 1: Authorization Request**

This grant type starts with the authorization request from the client `academy.htb` to the authorization server `hubgit.htb`:

{% code overflow="wrap" %}
```http
GET /auth?client_id=1337&redirect_uri=http://academy.htb/callback&response_type=code&scope=user&state=a45c12e87d4522 HTTP/1.1 
Host: hubgit.htb

```
{% endcode %}

This request contains multiple interesting GET parameters:

* `client_id`: A unique identifier for the client `academy.htb`
* `redirect_uri`: The URL to which the browser will be redirected after a successful authorization by the resource owner
* `response_type`: This is always set to `code` for the authorization code grant
* `scope`: This indicates what resources the client `academy.htb` needs to access. This parameter is optional
* `state`: A random nonce generated by the client that serves a similar purpose to a CSRF token tying the authorization request to the following callback request. This parameter is optional

### **Step 2: Resource Owner Authentication**

The authorization server `hubgit.htb` will request the user to log in and authorize the client `academy.htb` to access the requested resources.

### **Step 3: Authorization Code Grant**

The authorization server redirects the browser to the URL specified in the `redirect_uri` parameter of the authorization request:

```http
GET /callback?code=ptsmyq2zxyvv23bl&state=a45c12e87d4522 HTTP/1.1
Host: academy.htb

```

This request contains two parameters:

* `code`: The authorization code issued by the authorization server
* `state`: The `state` value from the authorization request to tie these two requests together

### **Step 4: Access Token Request**

After obtaining the authorization code, the client requests an access token from the authorization server:

{% code overflow="wrap" lineNumbers="true" fullWidth="false" %}
```http
POST /token HTTP/1.1
Host: hubgit.htb

client_id=1337&client_secret=SECRET&redirect_uri=http://academy.htb/callback&grant_type=authorization_code&code=ptsmyq2zxyvv23bl
```
{% endcode %}

In addition to the previously discussed parameters, this request contains two new parameters:

* `client_secret`: A secret value assigned to the client by the authorization server during the initial registration. This value authenticates the client to the authorization server
* `grant_type`: This is always set to `authorization_code` for the authorization code grant

### **Step 5: Access Token Grant**

The authorization server validates the authorization code and issues a valid access token for the resource server in response to the token request:

```json
{
  "access_token":"RsT5OjbzRn430zqMLgV3Ia",
  "expires_in":3600
}
```

### **Step 6: Resource Request**

The client now holds a valid access token for the resource server and can use this access token to request the resource owner's information:

```http
GET /user_info HTTP/1.1
Host: hubgit.htb
Authorization: Bearer RsT5OjbzRn430zqMLgV3Ia

```

### **Step 7: Resource Response**

The resource server validates the access token and responds with the resource owner's information:

```json
{username: "john", email: "john@hubgit.htb", id: 1337}
```



{% hint style="warning" %}
Use of Implicit Grant has been disabled in Oauth 2.0
{% endhint %}

## Implicit Flow

The implicit code grant is shorter than the authorization code grant as the authorization code exchange is skipped. This results in a more straightforward implementation at the cost of lower security since access tokens are exposed in the browser.

Therefore, it is generally preferable to use the authorization code grant if possible. However, in some cases, the client might not be able to store the authorization code securely. This might be the case for some client-side JavaScript applications. The implicit grant can be used when quick access is required, and the security risks associated with token exposure have been evaluated and deemed acceptable.

<figure><img src="../../.gitbook/assets/Diagram4.png" alt=""><figcaption><p>Implicit Grant Flow</p></figcaption></figure>

### **Step 1: Authorization Request**

The implicit grant type starts with a slightly different authorization request compared to the authorization code grant type:

{% code overflow="wrap" lineNumbers="true" %}
```http
GET /auth?client_id=1337&redirect_uri=http://academy.htb/callback&response_type=token&scope=user&state=a45c12e87d4522 HTTP/1.1 
Host: hubgit.htb

```
{% endcode %}

The `response_type` parameter is set to `token`. All other parameters retain the same meaning.

### **Step 2: Resource Owner Authentication**

The authorization server `hubgit.htb` will request the user to log in and authorize the client `academy.htb` to access the requested resources. This is the same as in the authorization code grant.

### **Step 3: Access Token Grant**

This step is the main difference from the authorization token grant. Like before, the authorization server redirects the browser to the URL specified in the authorization request's `redirect_uri` parameter. Instead of providing an authorization code, this redirect already contains the access token in a URL fragment where it can be extracted using suitable client-side JavaScript code.

{% code overflow="wrap" lineNumbers="true" %}
```http
GET /callback#access_token=RsT5OjbzRn430zqMLgV3Ia&token_type=Bearer&expires_in=3600&scope=user&state=a45c12e87d4522 HTTP/1.1
Host: academy.htb

```
{% endcode %}

### **Step 4: Resource Request**

The client now holds a valid access token for the resource server and can use this access token to request the resource owner's information. This is the same as in the authorization code grant.

```http
GET /user_info HTTP/1.1
Host: hubgit.htb
Authorization: Bearer RsT5OjbzRn430zqMLgV3Ia

```

### **Step 5: Resource Response**

The resource server validates the access token and responds with the resource owner's information. This is the same as in the authorization code grant.

```json
{username: "john", email: "john@hubgit.htb", id: 1337}
```
